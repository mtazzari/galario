<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>3. A quickstart example &#8212; galario 1.2.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/pydoctheme.css" />
    <link rel="stylesheet" type="text/css" href="_static/css/custom.css" />
    
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"></script>
    
    <script src="_static/sidebar.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="4. Technical specifications" href="tech-specs.html" />
    <link rel="prev" title="2. Basic Usage" href="basic_usage.html" />

    
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    


    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-106731281-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-106731281-3');
    </script>


  </head><body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
        <li><a href="index.html">galario 1.2.2 documentation</a> &#187;</li> 
      </ul>
    </div>
    
        <div class="badge">
            <a href="https://github.com/mtazzari/galario/">Fork me on GitHub</a>
            <img src="_static/right-red@2x.png">
        </div>
    
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="a-quickstart-example">
<h1><span class="section-number">3. </span>A quickstart example<a class="headerlink" href="#a-quickstart-example" title="Permalink to this heading">¶</a></h1>
<p>In this page we show how to use <strong>galario</strong> in some typical use cases, e.g. the fit of some interferometric data sets.</p>
<p><strong>galario</strong> has been designed to simplify and accelerate the task of computing the synthetic visibilities given a model
image, leaving to the user the freedom to choose the most appropriate statistical tool for the parameter space exploration.</p>
<p>For the purpose of these examples we will adopt a Bayesian approach, using Monte Carlo Markov chains to explore the
parameter space and to produce a sampling of the posterior probability function. In particular, we will use the MCMC
implementation in the <a class="reference external" href="http://dfm.io/emcee/current/">emcee</a> Python package.</p>
<p>In this page we will show how to fit the mock observations of a protoplanetary disk. In particular, in the example we will
analyse mock visibilities of the disk continuum emission at <span class="math notranslate nohighlight">\(\lambda=\)</span> 1 mm whose synthetized map is shown in this figure:</p>
<a class="reference internal image-reference" href="_images/disk_example.jpg"><img alt="Protoplanetary disk continuum map" class="align-center" src="_images/disk_example.jpg" style="width: 605.7px; height: 590.4px;" /></a>
<p>You can download <a class="reference external" href="uvtable.txt">here</a> an ASCII version of the uv-table used in this example.</p>
<hr class="docutils" />
<section id="fit-a-single-wavelength-data-set">
<h2><span class="section-number">3.1. </span>Fit a single-wavelength data set<a class="headerlink" href="#fit-a-single-wavelength-data-set" title="Permalink to this heading">¶</a></h2>
<p><strong>1) Import the uv table</strong></p>
<blockquote>
<div><p>First, let’s import the table containing the interferometric observations. Typically, an interferometric data set
can be exported to a table containing the <span class="math notranslate nohighlight">\((u_j, v_j)\)</span> coordinates (<span class="math notranslate nohighlight">\(j=1...M\)</span>), the Real and Imaginary part of the complex visibilities
<span class="math notranslate nohighlight">\(V_{obs\ j}\)</span>, and their theoretical weight <span class="math notranslate nohighlight">\(w_{j}\)</span>, for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">u</span>  <span class="p">[</span><span class="n">m</span><span class="p">]</span>          <span class="n">v</span>  <span class="p">[</span><span class="n">m</span><span class="p">]</span>          <span class="n">Re</span>  <span class="p">[</span><span class="n">Jy</span><span class="p">]</span>        <span class="n">Im</span>  <span class="p">[</span><span class="n">Jy</span><span class="p">]</span>        <span class="n">w</span>
<span class="o">-------------------------------------------------------------------------</span>
<span class="o">-</span><span class="mf">155.90093</span>      <span class="mf">234.34887</span>        <span class="mf">0.01810</span>         <span class="mf">0.13799</span>        <span class="mf">200.05723</span>
<span class="mf">9.290660</span>        <span class="mf">362.97853</span>       <span class="o">-</span><span class="mf">0.05827</span>         <span class="mf">0.02820</span>        <span class="mf">216.95405</span>
<span class="mf">95.23531</span>        <span class="mf">109.22704</span>        <span class="mf">0.06314</span>        <span class="o">-</span><span class="mf">0.16727</span>        <span class="mf">167.18789</span>
<span class="mf">94.01319</span>        <span class="mf">251.97293</span>        <span class="mf">0.01974</span>         <span class="mf">0.04358</span>        <span class="mf">179.69114</span>
<span class="o">-</span><span class="mf">60.45751</span>       <span class="mf">211.33346</span>        <span class="mf">0.14856</span>        <span class="o">-</span><span class="mf">0.07756</span>        <span class="mf">188.09953</span>
<span class="mf">91.59843</span>        <span class="mf">68.94947</span>         <span class="mf">0.12741</span>        <span class="o">-</span><span class="mf">0.12871</span>        <span class="mf">156.32432</span>
<span class="mf">23.29531</span>        <span class="mf">251.71338</span>        <span class="mf">0.01568</span>        <span class="o">-</span><span class="mf">0.12316</span>        <span class="mf">189.58017</span>
<span class="o">-</span><span class="mf">135.83509</span>      <span class="o">-</span><span class="mf">29.77982</span>       <span class="o">-</span><span class="mf">0.02017</span>        <span class="o">-</span><span class="mf">0.00010</span>        <span class="mf">207.29354</span>
<span class="mf">59.38624</span>        <span class="mf">144.99431</span>        <span class="mf">0.04759</span>        <span class="o">-</span><span class="mf">0.08606</span>        <span class="mf">201.32301</span>
<span class="mf">192.43093</span>       <span class="mf">171.57617</span>       <span class="o">-</span><span class="mf">0.02176</span>        <span class="o">-</span><span class="mf">0.02661</span>        <span class="mf">208.52030</span>
<span class="o">-</span><span class="mf">243.91416</span>      <span class="mf">76.18790</span>        <span class="o">-</span><span class="mf">0.02306</span>        <span class="o">-</span><span class="mf">0.01430</span>        <span class="mf">207.16036</span>
<span class="mf">58.72442</span>        <span class="mf">276.64959</span>        <span class="mf">0.03325</span>         <span class="mf">0.04560</span>        <span class="mf">173.15922</span>
<span class="mf">35.56591</span>        <span class="mf">111.28235</span>        <span class="mf">0.03777</span>        <span class="o">-</span><span class="mf">0.11856</span>        <span class="mf">194.83899</span>
<span class="o">...</span>             <span class="o">...</span>             <span class="o">...</span>             <span class="o">...</span>             <span class="o">...</span>
</pre></div>
</div>
<p>You can download <a class="reference external" href="uvtable.txt">here</a> an ASCII version of the uv-table used in this example.</p>
<p>A table like this one can be read with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">Im</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;uvtable.txt&quot;</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">requirements</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
<span class="n">wle</span> <span class="o">=</span> <span class="mf">1e-3</span>  <span class="c1"># [m]</span>
<span class="n">u</span> <span class="o">/=</span> <span class="n">wle</span>
<span class="n">v</span> <span class="o">/=</span> <span class="n">wle</span>
</pre></div>
</div>
<p>where the <span class="math notranslate nohighlight">\(u_j\)</span> and <span class="math notranslate nohighlight">\(v_j\)</span> coordinates have been converted in units of the observing wavelength, 1 mm in this example. The <code class="code docutils literal notranslate"><span class="pre">np.require</span></code> command is necessary to ensure that the arrays are C-contiguous as required by <strong>galario</strong> (see <a class="reference internal" href="FAQ.html#faq1-1"><span class="std std-ref">FAQ 1.1</span></a>).</p>
</div></blockquote>
<dl>
<dt><strong>2) Determine the image size</strong></dt><dd><p>Once imported the uv table, we can start using <strong>galario</strong> to compute the optimal image size</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">galario.double</span> <span class="kn">import</span> <span class="n">get_image_size</span>

<span class="n">nxy</span><span class="p">,</span> <span class="n">dxy</span> <span class="o">=</span> <span class="n">get_image_size</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>where the returned values are the number of pixels (<code class="code docutils literal notranslate"><span class="pre">nxy</span></code>) and the pixel size (<code class="code docutils literal notranslate"><span class="pre">dxy</span></code>) in radians.
<code class="code docutils literal notranslate"><span class="pre">nxy</span></code> and <code class="code docutils literal notranslate"><span class="pre">dxy</span></code> are chosen to fulfil criteria that ensure a correct computation of the synthetic visibilities.
For more details, refer to Sect. 3.2 in <a class="reference external" href="https://doi.org/10.1093/mnras/sty409">Tazzari, Beaujean and Testi (2018) MNRAS 476 4527</a>.</p>
</dd>
<dt><strong>3) Define the brightness model</strong></dt><dd><p>Let us define the model: for this example, we will use a very simple Gaussian profile:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">galario</span> <span class="kn">import</span> <span class="n">arcsec</span>

<span class="k">def</span> <span class="nf">GaussianProfile</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">Rmin</span><span class="p">,</span> <span class="n">dR</span><span class="p">,</span> <span class="n">nR</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Gaussian brightness profile. &quot;&quot;&quot;</span>

    <span class="c1"># radial grid</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">Rmin</span><span class="p">,</span> <span class="n">Rmin</span> <span class="o">+</span> <span class="n">dR</span><span class="o">*</span><span class="n">nR</span><span class="p">,</span> <span class="n">nR</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">R</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="code docutils literal notranslate"><span class="pre">f0</span></code> (Jy/sr) is a normalization, <code class="code docutils literal notranslate"><span class="pre">sigma</span></code> is the width of the Gaussian, <code class="code docutils literal notranslate"><span class="pre">Rmin</span></code> is the
innermost radius of the grid, <code class="code docutils literal notranslate"><span class="pre">dR</span></code> is the size of radial grid and <code class="code docutils literal notranslate"><span class="pre">nR</span></code> is the number of radial grid cells.
<code class="code docutils literal notranslate"><span class="pre">sigma</span></code>, <code class="code docutils literal notranslate"><span class="pre">Rmin</span></code>, <code class="code docutils literal notranslate"><span class="pre">dR</span></code> should be passed to <code class="code docutils literal notranslate"><span class="pre">GaussianProfile()</span></code> in arcseconds and <code class="code docutils literal notranslate"><span class="pre">f0</span></code> in Jy/sr.</p>
</dd>
<dt><strong>4) Setup the MCMC Ensemble Sampler</strong></dt><dd><p>In our fit we will have 6 free parameters: on top of the model parameters <code class="code docutils literal notranslate"><span class="pre">f0</span></code> and <code class="code docutils literal notranslate"><span class="pre">sigma</span></code> we want to fit
the inclination <code class="code docutils literal notranslate"><span class="pre">inc</span></code>, the position angle <code class="code docutils literal notranslate"><span class="pre">PA</span></code>, and the angular offsets <span class="math notranslate nohighlight">\((\Delta RA, \Delta Dec)\)</span>
with respect to the phase center.
Following the notation of the <a class="reference external" href="http://dfm.io/emcee/current/">emcee</a> documentation, we initialise the EnsembleSampler</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">emcee</span> <span class="kn">import</span> <span class="n">EnsembleSampler</span>

<span class="c1"># radial grid parameters</span>
<span class="n">Rmin</span> <span class="o">=</span> <span class="mf">1e-4</span>  <span class="c1"># arcsec</span>
<span class="n">dR</span> <span class="o">=</span> <span class="mf">0.01</span>    <span class="c1"># arcsec</span>
<span class="n">nR</span> <span class="o">=</span> <span class="mi">2000</span>

<span class="c1"># parameter space domain</span>
<span class="n">p_ranges</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">]]</span>

<span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_ranges</span><span class="p">)</span>        <span class="c1"># number of dimensions</span>
<span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">40</span>               <span class="c1"># number of walkers</span>

<span class="n">nthreads</span> <span class="o">=</span> <span class="mi">4</span>                <span class="c1"># CPU threads that emcee should use</span>

<span class="n">sampler</span> <span class="o">=</span> <span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">lnpostfn</span><span class="p">,</span>
                          <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">p_ranges</span><span class="p">,</span> <span class="n">Rmin</span><span class="p">,</span> <span class="n">dR</span><span class="p">,</span> <span class="n">nR</span><span class="p">,</span> <span class="n">nxy</span><span class="p">,</span> <span class="n">dxy</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">Im</span><span class="p">,</span> <span class="n">w</span><span class="p">],</span>
                          <span class="n">threads</span><span class="o">=</span><span class="n">nthreads</span><span class="p">)</span>
</pre></div>
</div>
<p>where:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">p_ranges</span></code> is a rectangular domain in the parameter space that defines the search region;</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">lnpostfn</span></code> is the posterior probability function;</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">args</span></code> defines an array of fixed parameters that <code class="code docutils literal notranslate"><span class="pre">lnpostfn</span></code> takes additionally in input.</p></li>
</ul>
</div></blockquote>
</dd>
<dt><strong>5) Define the posterior and the prior probability functions</strong></dt><dd><p>Let us now implement the posterior function, using <strong>galario</strong> to compute the <span class="math notranslate nohighlight">\(\chi^2\)</span>. Since in this example
we are assuming an axisymmetric brightness profile we will use the <code class="code docutils literal notranslate"><span class="pre">chi2Profile</span></code> function, but the same design holds
for the <code class="code docutils literal notranslate"><span class="pre">chi2Image</span></code> function that should be used for non-axisymmetric profiles.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">galario</span> <span class="kn">import</span> <span class="n">deg</span><span class="p">,</span> <span class="n">arcsec</span>
<span class="kn">from</span> <span class="nn">galario.double</span> <span class="kn">import</span> <span class="n">chi2Profile</span>

<span class="k">def</span> <span class="nf">lnpostfn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_ranges</span><span class="p">,</span> <span class="n">Rmin</span><span class="p">,</span> <span class="n">dR</span><span class="p">,</span> <span class="n">nR</span><span class="p">,</span> <span class="n">nxy</span><span class="p">,</span> <span class="n">dxy</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">Im</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Log of posterior probability function &quot;&quot;&quot;</span>

    <span class="n">lnprior</span> <span class="o">=</span> <span class="n">lnpriorfn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_ranges</span><span class="p">)</span>  <span class="c1"># apply prior</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lnprior</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="c1"># unpack the parameters</span>
    <span class="n">f0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">PA</span><span class="p">,</span> <span class="n">dRA</span><span class="p">,</span> <span class="n">dDec</span> <span class="o">=</span> <span class="n">p</span>

    <span class="n">f0</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="n">f0</span>        <span class="c1"># convert from log to real space</span>

    <span class="c1"># convert to radians</span>
    <span class="n">sigma</span> <span class="o">*=</span> <span class="n">arcsec</span>
    <span class="n">Rmin</span> <span class="o">*=</span> <span class="n">arcsec</span>
    <span class="n">dR</span> <span class="o">*=</span> <span class="n">arcsec</span>
    <span class="n">inc</span> <span class="o">*=</span> <span class="n">deg</span>
    <span class="n">PA</span> <span class="o">*=</span> <span class="n">deg</span>
    <span class="n">dRA</span> <span class="o">*=</span> <span class="n">arcsec</span>
    <span class="n">dDec</span> <span class="o">*=</span> <span class="n">arcsec</span>

    <span class="c1"># compute the model brightness profile</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">GaussianProfile</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">Rmin</span><span class="p">,</span> <span class="n">dR</span><span class="p">,</span> <span class="n">nR</span><span class="p">)</span>

    <span class="n">chi2</span> <span class="o">=</span> <span class="n">chi2Profile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Rmin</span><span class="p">,</span> <span class="n">dR</span><span class="p">,</span> <span class="n">nxy</span><span class="p">,</span> <span class="n">dxy</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">Im</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span>
                       <span class="n">inc</span><span class="o">=</span><span class="n">inc</span><span class="p">,</span> <span class="n">PA</span><span class="o">=</span><span class="n">PA</span><span class="p">,</span> <span class="n">dRA</span><span class="o">=</span><span class="n">dRA</span><span class="p">,</span> <span class="n">dDec</span><span class="o">=</span><span class="n">dDec</span><span class="p">)</span>

    <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">chi2</span> <span class="o">+</span> <span class="n">lnprior</span>
</pre></div>
</div>
<p>where the normalization <code class="code docutils literal notranslate"><span class="pre">f0</span></code> is explored in the logarithmic space to achieve a faster convergence and <code class="code docutils literal notranslate"><span class="pre">lnpriorfn</span></code>
is the prior probability function defined as a uniform prior:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">lnpriorfn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">par_ranges</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Uniform prior probability function &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">par_ranges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">par_ranges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="n">jacob</span> <span class="o">=</span> <span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>       <span class="c1"># jacobian of the log transformation</span>

    <span class="k">return</span> <span class="n">jacob</span>
</pre></div>
</div>
<p>which, up to a constant, basically checks that <code class="code docutils literal notranslate"><span class="pre">p</span></code> lies inside the rectangular domain defined by the extents in <code class="code docutils literal notranslate"><span class="pre">p_ranges</span></code>.</p>
</dd>
<dt><strong>6) Ready to go: run the MCMC!</strong></dt><dd><p>We are now ready to start the MCMC:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">nsteps</span> <span class="o">=</span> <span class="mi">3000</span>     <span class="c1"># total number of MCMC steps</span>

<span class="c1"># initial guess for the parameters</span>
<span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">70.</span><span class="p">,</span> <span class="mf">60.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span> <span class="c1">#  3 parameters for the model + 4 (inc, PA, dRA, dDec)</span>

<span class="c1"># initialize the walkers with an ndim-dimensional Gaussian ball</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">p0</span> <span class="o">+</span> <span class="mf">1e-4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">)]</span>

<span class="c1"># execute the MCMC</span>
<span class="n">pos</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">rstate0</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">lnprob0</span><span class="o">=</span><span class="n">prob</span><span class="p">)</span>
</pre></div>
</div>
<p>It is possible to run the whole fit collecting the code blocks above into a single <code class="code docutils literal notranslate"><span class="pre">quickstart.py</span></code> file and running <code class="code docutils literal notranslate"><span class="pre">python</span> <span class="pre">quickstart.py</span></code>. For reference, using <code class="code docutils literal notranslate"><span class="pre">nthreads=4</span></code>, the run takes approximately 5-8 mins on a laptop with an Intel i5 2.9GHz.</p>
</dd>
</dl>
<p><strong>7) Plot the fit results</strong></p>
<blockquote>
<div><p>Once the run has completed, we can inspect the fit results. We will produce two informative plots. First, the so called corner plot, which shows the 1D and 2D marginalised posterior distributions of the free parameters (bottom left figure). To produce this plot we use the <a class="reference external" href="https://github.com/dfm/corner.py">corner</a> package, which can be easily installed with <code class="code docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">corner</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># do the corner plot</span>
<span class="kn">import</span> <span class="nn">corner</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">chain</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1000</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndim</span><span class="p">))</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;$f_0$&quot;</span><span class="p">,</span> <span class="s2">&quot;$\sigma$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$i$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;PA&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\Delta$RA&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\Delta$Dec&quot;</span><span class="p">],</span>
                    <span class="n">show_titles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.84</span><span class="p">],</span>
                    <span class="n">label_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;labelpad&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;fontsize&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">},</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;triangle_example.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Second, the so called uv-plot which shows the comparison between the visibilities of the bestfit model and the observed ones (bottom right figure). To produce the uv-plot we use the <a class="reference external" href="https://github.com/mtazzari/uvplot">uvplot</a> package, which can be easily installed with <code class="code docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">uvplot</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># do the uv-plot</span>
<span class="c1"># select the bestfit model (here, e.g., the model with median parameters)</span>
<span class="n">bestfit</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="mi">50</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)]</span>

<span class="n">f0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">PA</span><span class="p">,</span> <span class="n">dRA</span><span class="p">,</span> <span class="n">dDec</span> <span class="o">=</span> <span class="n">bestfit</span>

<span class="n">f0</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="n">f0</span>        <span class="c1"># convert from log to real space</span>

<span class="c1"># convert to radians</span>
<span class="n">sigma</span> <span class="o">*=</span> <span class="n">arcsec</span>
<span class="n">Rmin</span> <span class="o">*=</span> <span class="n">arcsec</span>
<span class="n">dR</span> <span class="o">*=</span> <span class="n">arcsec</span>
<span class="n">inc</span> <span class="o">*=</span> <span class="n">deg</span>
<span class="n">PA</span> <span class="o">*=</span> <span class="n">deg</span>
<span class="n">dRA</span> <span class="o">*=</span> <span class="n">arcsec</span>
<span class="n">dDec</span> <span class="o">*=</span> <span class="n">arcsec</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">GaussianProfile</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">Rmin</span><span class="p">,</span> <span class="n">dR</span><span class="p">,</span> <span class="n">nR</span><span class="p">)</span>

<span class="c1"># compute the visibilities of the bestfit model</span>
<span class="n">vis_mod</span> <span class="o">=</span> <span class="n">g_double</span><span class="o">.</span><span class="n">sampleProfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Rmin</span><span class="p">,</span> <span class="n">dR</span><span class="p">,</span> <span class="n">nxy</span><span class="p">,</span> <span class="n">dxy</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span>
                                 <span class="n">inc</span><span class="o">=</span><span class="n">inc</span><span class="p">,</span> <span class="n">PA</span><span class="o">=</span><span class="n">PA</span><span class="p">,</span> <span class="n">dRA</span><span class="o">=</span><span class="n">dRA</span><span class="p">,</span> <span class="n">dDec</span><span class="o">=</span><span class="n">dDec</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">uvplot</span> <span class="kn">import</span> <span class="n">UVTable</span>

<span class="n">uvbin_size</span> <span class="o">=</span> <span class="mf">30e3</span>     <span class="c1"># uv-distance bin, units: wle</span>

<span class="c1"># observations uv-plot</span>
<span class="n">uv</span> <span class="o">=</span> <span class="n">UVTable</span><span class="p">(</span><span class="n">uvtable</span><span class="o">=</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">wle</span><span class="p">,</span> <span class="n">v</span><span class="o">*</span><span class="n">wle</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">Im</span><span class="p">,</span> <span class="n">w</span><span class="p">],</span> <span class="n">wle</span><span class="o">=</span><span class="n">wle</span><span class="p">)</span>
<span class="n">uv</span><span class="o">.</span><span class="n">apply_phase</span><span class="p">(</span><span class="o">-</span><span class="n">dRA</span><span class="p">,</span> <span class="o">-</span><span class="n">dDec</span><span class="p">)</span>         <span class="c1"># center the source on the phase center</span>
<span class="n">uv</span><span class="o">.</span><span class="n">deproject</span><span class="p">(</span><span class="n">inc</span><span class="p">,</span> <span class="n">PA</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">uv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span> <span class="n">uvbin_size</span><span class="o">=</span><span class="n">uvbin_size</span><span class="p">)</span>

<span class="c1"># model uv-plot</span>
<span class="n">uv_mod</span> <span class="o">=</span> <span class="n">UVTable</span><span class="p">(</span><span class="n">uvtable</span><span class="o">=</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">wle</span><span class="p">,</span> <span class="n">v</span><span class="o">*</span><span class="n">wle</span><span class="p">,</span> <span class="n">vis_mod</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">vis_mod</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">w</span><span class="p">],</span> <span class="n">wle</span><span class="o">=</span><span class="n">wle</span><span class="p">)</span>
<span class="n">uv_mod</span><span class="o">.</span><span class="n">apply_phase</span><span class="p">(</span><span class="o">-</span><span class="n">dRA</span><span class="p">,</span> <span class="o">-</span><span class="n">dDec</span><span class="p">)</span>     <span class="c1"># center the source on the phase center</span>
<span class="n">uv_mod</span><span class="o">.</span><span class="n">deproject</span><span class="p">(</span><span class="n">inc</span><span class="p">,</span> <span class="n">PA</span><span class="p">)</span>
<span class="n">uv_mod</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">uvbin_size</span><span class="o">=</span><span class="n">uvbin_size</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;uvplot_example.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><a class="reference internal image-reference" href="_images/quickstart_triangle_whole_chain.png"><img alt="Chains" src="_images/quickstart_triangle_whole_chain.png" style="width: 80%;" /></a>
</td>
<td><a class="reference internal image-reference" href="_images/uvplot.png"><img alt="Chains" src="_images/uvplot.png" style="width: 98%;" /></a>
</td>
</tr>
<tr class="row-even"><td><p>Corner plot showing the marginalised posteriors</p></td>
<td><p>Uv-plot showing the deprojected visibilities</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<dl>
<dt><strong>7) CPU vs GPU execution</strong></dt><dd><p>So far we have run <strong>galario</strong> on the CPU. Running it on a GPU can be done by just changing the import at the beginning:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">galario</span> <span class="kn">import</span> <span class="n">double_cuda</span> <span class="k">as</span> <span class="n">g_double</span>
</pre></div>
</div>
<p>All the rest of the code remains the same!</p>
<p>For more details on the GPU vs CPU execution, see the <a class="reference internal" href="cookbook.html#cookbook"><span class="std std-ref">Cookbook</span></a>.</p>
</dd>
</dl>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    <a id="sidebar-anchor"></a>
    

  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">1. Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic_usage.html">2. Basic Usage</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">3. Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#fit-a-single-wavelength-data-set">3.1. Fit a single-wavelength data set</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tech-specs.html">4. Tech specs</a></li>
<li class="toctree-l1"><a class="reference internal" href="cookbook.html">5. Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="py-api.html">6. Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="C%2B%2B-api.html">7. C++ API</a></li>
<li class="toctree-l1"><a class="reference internal" href="C%2B%2B-example.html">8. C++ Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="publications.html">9. Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">10. FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">11. License</a></li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="basic_usage.html"
                          title="previous chapter"><span class="section-number">2. </span>Basic Usage</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="tech-specs.html"
                          title="next chapter"><span class="section-number">4. </span>Technical specifications</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/quickstart.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
<div id="sidebarbutton" title="Collapse sidebar">
<span>«</span>
</div>

      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="tech-specs.html" title="4. Technical specifications"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="basic_usage.html" title="2. Basic Usage"
             accesskey="P">previous</a> |</li>
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2017-2023, Marco Tazzari, Frederik Beaujean, Leonardo Testi.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  </body>
</html>